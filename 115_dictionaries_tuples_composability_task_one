import time
import json
import threading
import websocket


#part of stopping the data stream - it was easier for me to iterate and test the code this
stop_event = threading.Event()

def collect_data():
    uri = "wss://ws.finnhub.io?token=cqohj5hr01qk95835l60cqohj5hr01qk95835l6g"

    ws = websocket.create_connection(uri)

    payload = {
        "type": "subscribe",
        "symbol": "BINANCE:BTCUSDT",
    }
    ws.send(json.dumps(payload))

    while not stop_event.is_set():
        message = ws.recv() #message comming in as a json struccture
        raw_data=json.loads(message) #placing json data in a dict
        relevant_data=(raw_data['data'][0])  #removing irrelevant data from the dict for easier manipulatios
        #aligned output
        print(f"{"Time:" : <6}{time.strftime('%Y-%m-%d %H:%M:%S', time.gmtime(relevant_data['t']/1000.0)) : <24}{"Price:" :<8}{relevant_data['p']: <14}{"Volume:" :<8}{relevant_data['v'] : <7}")
        

    ws.close()

#stopping the data stream automatically makes iterating and testing much easier, can be disabld for final version
t = threading.Thread(target=collect_data)
t.start()
time.sleep(10) #remove value to make infinite

stop_event.set()
t.join()
